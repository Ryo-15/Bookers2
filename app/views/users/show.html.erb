<%# ログイン後画面・自分の投稿一覧（マイページ） %>
<%# Homeリンク %>
<div class="container">
  <div class="row">
    <div class="col-xs-3">
      <%# 部分テンプレート %>
      <%# プロフィール %>
      <%= render 'layouts/userinfo', user: @user %>
      <%# 新規投稿 %>
      <%= render 'layouts/booknew', book: @book %>
    </div>

    <div class="col-xs-9">
      <h2>Books</h2>
      <table class="table">
        <thead>
          <tr>
            <th></th>
            <th>title</th>
            <th>opinion</th>
            <th colspan="3"></th>
          </tr>
        </thead>

        <tbody>
          <% @books.each do |book| %>
            <tr>
              <td><span><%= attachment_image_tag @user, :profile_image, format: 'jpeg', class: "profile-img", fallback: "no_image.jpg", size: "40x40" %></span></td>
              <td><span><%= link_to book.title, "/books/#{book.id}"%></span></td>
              <td><%= book.body %></td>
              <%# コメント数を追加 %>
              <td><p class="comment-count">コメント数：<%= book.book_comments.count %></p></td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>

    <div class="container">
      <div class="row">
        <div class="col-xs-12">
          <%# マイページの場合、ここに住所情報 %>
          <% if @user.id == current_user.id %>
            <div class="your_map">
              <h2>Your MAP</h2>
              <script type="text/javascript">
                function initMap() {
                  // latitude,longitudeから位置を特定
                  var test ={lat: <%= @user.latitude %>, lng: <%= @user.longitude %>};
                  var map = new google.maps.Map(document.getElementById('map'), {
                            zoom: 15,
                            center: test
                            });
                  var transitLayer = new google.maps.TransitLayer();
                  transitLayer.setMap(map);

                  var contentString = '住所：<%= @user.address %>';
                  var infowindow = new google.maps.InfoWindow({
                    content: contentString
                  });

                  // Map上の指定した位置にピンを挿して表示する
                  var marker = new google.maps.Marker({
                                position:test,
                                map: map,
                                title: contentString
                              });

                  marker.addListener('click', function() {
                    infowindow.open(map, marker);
                  });
                }
              </script>

              <%# アドレス内 key= APIキーを記述 %>
              <%# Githubなどにアップロードすべきでない第三者に漏洩すると危険な外部のAPIキーの情報を環境変数として管理 →.env %>
              <script async defer
                            src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=ENV['GOOGLE_MAP_API_KEY']&callback=initMap">
              </script>
              <div id="map"></div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>